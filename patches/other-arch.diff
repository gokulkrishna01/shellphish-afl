Only in afl-other-arch: build.sh
Only in afl: .gitignore
diff -r afl/qemu_mode/build_qemu_support.sh afl-other-arch/qemu_mode/build_qemu_support.sh
24a25,28
> if [ $# -lt 1 ]; then
>     echo "usage: $0 <arches>" >&2
>     exit 1
> fi
120,126d123
< echo "[*] Configuring QEMU for $CPU_TARGET..."
< 
< ORIG_CPU_TARGET="$CPU_TARGET"
< 
< test "$CPU_TARGET" = "" && CPU_TARGET="`uname -m`"
< test "$CPU_TARGET" = "i686" && CPU_TARGET="i386"
< 
135,146c132,134
< echo "[+] Patching done."
< 
< # --enable-pie seems to give a couple of exec's a second performance
< # improvement, much to my surprise. Not sure how universal this is..
< 
< CFLAGS="-O3 -ggdb" ./configure --disable-system \
<   --enable-linux-user --disable-gtk --disable-sdl --disable-vnc \
<   --target-list="${CPU_TARGET}-linux-user" --enable-pie --enable-kvm || exit 1
< 
< echo "[+] Configuration complete."
< 
< echo "[*] Attempting to build QEMU (fingers crossed!)..."
---
> if [ "`lsb_release -a 2>/dev/null | grep Release | awk '{print $2}'`" = 18.04 ]; then
>     patch -p1 <../patches/memfd.diff
> fi
148d135
< make || exit 1
150c137
< echo "[+] Build process successful!"
---
> echo "[+] Patching done."
152c139
< echo "[*] Copying binary..."
---
> CPU_TARGETS=$@
154c141
< cp -f "${CPU_TARGET}-linux-user/qemu-${CPU_TARGET}" "../../afl-qemu-trace" || exit 1
---
> for CPU_TARGET in $CPU_TARGETS; do
156,157c143
< cd ..
< ls -l ../afl-qemu-trace || exit 1
---
>     echo "[*] Configuring QEMU for $CPU_TARGET..."
159c145,146
< echo "[+] Successfully created '../afl-qemu-trace'."
---
>     # --enable-pie seems to give a couple of exec's a second performance
>     # improvement, much to my surprise. Not sure how universal this is..
161c148,150
< if [ "$ORIG_CPU_TARGET" = "" ]; then
---
>     CFLAGS="-O3 -ggdb" ./configure --disable-system --python=`which python2` \
>       --enable-linux-user --disable-gtk --disable-sdl --disable-vnc \
>       --target-list="${CPU_TARGET}-linux-user" --enable-pie --enable-kvm || exit 1
163c152
<   echo "[*] Testing the build..."
---
>     echo "[+] Configuration complete."
165c154
<   cd ..
---
>     echo "[*] Attempting to build QEMU (fingers crossed!)..."
167c156
<   make >/dev/null || exit 1
---
>     make -j || exit 1
169c158
<   gcc test-instr.c -o test-instr || exit 1
---
>     echo "[+] Build process successful!"
171c160
<   unset AFL_INST_RATIO
---
>     echo "[*] Copying binary..."
173,174c162
<   echo 0 | ./afl-showmap -m none -Q -q -o .test-instr0 ./test-instr || exit 1
<   echo 1 | ./afl-showmap -m none -Q -q -o .test-instr1 ./test-instr || exit 1
---
>     cp -f "${CPU_TARGET}-linux-user/qemu-${CPU_TARGET}" "../../afl-qemu-trace" || exit 1
176c164
<   rm -f test-instr
---
>     mkdir -p ../../tracers/$CPU_TARGET
178,179c166,167
<   cmp -s .test-instr0 .test-instr1
<   DR="$?"
---
>     cp -f "${CPU_TARGET}-linux-user/qemu-${CPU_TARGET}" "../../tracers/${CPU_TARGET}/afl-qemu-trace" || exit 1
> done
181c169
<   rm -f .test-instr0 .test-instr1
---
> cd ..
183c171
<   if [ "$DR" = "0" ]; then
---
> ls -l ../afl-qemu-trace || exit 1
185,186c173
<     echo "[-] Error: afl-qemu-trace instrumentation doesn't seem to work!"
<     exit 1
---
> echo "[+] Successfully created '../afl-qemu-trace'."
188c175
<   fi
---
> echo "[*] Testing the build..."
190,191c177
<   echo "[+] Instrumentation tests passed. "
<   echo "[+] All set, you can now use the -Q mode in afl-fuzz!"
---
> cd ..
193c179
< else
---
> make -j >/dev/null || exit 1
195,196c181,202
<   echo "[!] Note: can't test instrumentation when CPU_TARGET set."
<   echo "[+] All set, you can now (hopefully) use the -Q mode in afl-fuzz!"
---
> #gcc test-instr.c -o test-instr || exit 1
> #
> #unset AFL_INST_RATIO
> #
> #echo 0 | ./afl-showmap -m none -Q -q -o .test-instr0 ./test-instr || exit 1
> #echo 1 | ./afl-showmap -m none -Q -q -o .test-instr1 ./test-instr || exit 1
> #
> #rm -f test-instr
> #
> #cmp -s .test-instr0 .test-instr1
> #DR="$?"
> #
> #rm -f .test-instr0 .test-instr1
> #
> #if [ "$DR" = "0" ]; then
> #
> #  echo "[-] Error: afl-qemu-trace instrumentation doesn't seem to work!"
> #  exit 1
> #
> #fi
> #
> #echo "[+] Instrumentation tests passed. "
198c204
< fi
---
> echo "[+] All set, you can now use the -Q mode in afl-fuzz!"
Only in afl-other-arch/qemu_mode/patches: memfd.diff
diff -r afl/qemu_mode/patches/syscall.diff afl-other-arch/qemu_mode/patches/syscall.diff
12c12,36
< @@ -11688,8 +11690,21 @@
---
> @@ -255,6 +257,8 @@
>  #define TARGET_NR__llseek TARGET_NR_llseek
>  #endif
>  
> +static bool last_read_empty = false;
> +
>  #ifdef __NR_gettid
>  _syscall0(int, gettid)
>  #else
> @@ -7775,6 +7779,14 @@
>              if (!(p = lock_user(VERIFY_WRITE, arg2, arg3, 0)))
>                  goto efault;
>              ret = get_errno(safe_read(arg1, p, arg3));
> +            if (ret == 0) {
> +                if (last_read_empty) {
> +                    exit_group(1);
> +                }
> +                last_read_empty = true;
> +            } else {
> +                last_read_empty = false;
> +            }
>              if (ret >= 0 &&
>                  fd_trans_host_to_target_data(arg1)) {
>                  ret = fd_trans_host_to_target_data(arg1)(p, ret);
> @@ -11688,8 +11700,21 @@
Only in afl: README
Only in afl-other-arch: README.md
